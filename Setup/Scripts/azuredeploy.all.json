{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "clusterAttachedStorageType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Premium_LRS"
      ]
    },
    "provisionSpark": {
      "type": "string",
      "defaultValue": "Yes",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Specifies whether to provision an Azure Databricks Spark workspace."
      }
    },
    "provisionLLAP": {
      "type": "string",
      "defaultValue": "Yes",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Specifies whether to provision an LLAP cluster."
      }
    },
    "provisionKafka": {
      "type": "string",
      "defaultValue": "Yes",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Specifies whether to provision a Kafka cluster."
      }
    },
    "provisionSecure": {
      "type": "string",
      "defaultValue": "Yes",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Specifies whether to provision a Secured cluster."
      }
    },
    "clusterName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure Databricks workspace and/or HDInsight cluster to create."
      }
    },
    "pricingTier": {
      "type": "string",
      "defaultValue": "standard",
      "allowedValues": [
        "standard",
        "premium"
      ],
      "metadata": {
        "description": "The pricing tier of Databricks workspace."
      }
    },
    "clusterLoginUserName": {
      "type": "string",
      "defaultValue": "admin",
      "metadata": {
        "description": "These credentials can be used to submit jobs to the cluster and to log into cluster dashboards."
      }
    },
    "clusterLoginPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password must be at least 10 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "westus2",
      "metadata": {
        "description": "The location where all azure resources will be deployed."
      }
    },
    "clusterVersion": {
      "type": "string",
      "defaultValue": "3.6",
      "metadata": {
        "description": "HDInsight cluster version."
      }
    },
    "clusterWorkerNodeCount": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "The number of nodes in the HDInsight cluster."
      }
    },
    "clusterKind": {
      "type": "string",
      "defaultValue": "SPARK",
      "metadata": {
        "description": "The type of the HDInsight cluster to create."
      }
    },
    "sshUserName": {
      "type": "string",
      "defaultValue": "sshuser",
      "metadata": {
        "description": "These credentials can be used to remotely access the cluster."
      }
    },
    "sshPublicKey": {
      "type": "securestring",
      "metadata": {
        "description": "This field must be a valid SSH public key."
      }
    },
    "sshPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password must be at least 10 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
      }
    },
    "clusterCount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "The number of HDInsight clusters to deploy."
      }
    },
    "databaseAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "Username for external metastore DB Admin"
      }
    },
    "databaseAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for external metastore DB Admin"
      }
    },
    "virtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Virtual Network to Create"
      },
      "defaultValue": "adVNET"
    },
    "virtualNetworkAddressRange": {
      "type": "string",
      "metadata": {
        "description": "The address range of the new VNET in CIDR format"
      },
      "defaultValue": "10.0.0.0/16"
    },
    "adSubnetName": {
      "type": "string",
      "metadata": {
        "description": "The name of the subnet created in the new VNET"
      },
      "defaultValue": "adSubnet"
    },
    "adSubnet": {
      "type": "string",
      "metadata": {
        "description": "The address range of the subnet created in the new VNET"
      },
      "defaultValue": "10.0.0.0/24"
    },
    "dnsServerZone": {
      "type": "string",
      "metadata": {
        "description": "The address range of the subnet created in the new VNET"
      },
      "defaultValue": "10.in-addr.arpa"
    },
    "adPDCNicName": {
      "type": "string",
      "metadata": {
        "description": "The name of the NIC attached to the new PDC"
      },
      "defaultValue": "adPDCNic"
    },
    "adPDCNicIPAddress": {
      "type": "string",
      "metadata": {
        "description": "The IP address of the new AD PDC"
      },
      "defaultValue": "10.0.0.4"
    },
    "adBDCNicName": {
      "type": "string",
      "metadata": {
        "description": "The name of the NIC attached to the new BDC"
      },
      "defaultValue": "adBDCNic"
    },
    "adBDCNicIPAddress": {
      "type": "string",
      "metadata": {
        "description": "The IP address of the new AD BDC"
      },
      "defaultValue": "10.0.0.5"
    },
    "publicIPAddressName": {
      "type": "string",
      "metadata": {
        "description": "The name of the public IP address used by the Load Balancer"
      },
      "defaultValue": "adpublicIP"
    },
    "publicIPAddressType": {
      "type": "string",
      "allowedValues": [
        "Dynamic",
        "Static"
      ],
      "metadata": {
        "description": "The type of the public IP address used by the Load Balancer"
      },
      "defaultValue": "Dynamic"
    },
    "adPDCVMName": {
      "type": "string",
      "metadata": {
        "description": "The computer name of the PDC"
      },
      "defaultValue": "adPDC"
    },
    "adBDCVMName": {
      "type": "string",
      "metadata": {
        "description": "The computer name of the BDC"
      },
      "defaultValue": "adBDC"
    },
    "adVMSize": {
      "type": "string",
      "allowedValues": [
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14",
        "Standard_D1_v2",
        "Standard_DS1_v2",
        "Standard_D2_v2",
        "Standard_DS2_v2",
        "Standard_D3_v2",
        "Standard_DS3_v2",
        "Standard_D4_v2",
        "Standard_DS4_v2",
        "Standard_D11_v2",
        "Standard_DS11_v2",
        "Standard_D12_v2",
        "Standard_DS12_v2",
        "Standard_D13_v2",
        "Standard_DS13_v2",
        "Standard_D14_v2",
        "Standard_DS14_v2"
      ],
      "metadata": {
        "description": "The size of the VM Created"
      },
      "defaultValue": "Standard_DS2_v2"
    },
    "imagePublisher": {
      "type": "string",
      "defaultValue": "MicrosoftWindowsServer",
      "metadata": {
        "description": "Image Publisher"
      }
    },
    "imageOffer": {
      "type": "string",
      "defaultValue": "WindowsServer",
      "metadata": {
        "description": "Image Offer"
      }
    },
    "imageSKU": {
      "type": "string",
      "defaultValue": "2012-R2-Datacenter",
      "metadata": {
        "description": "Image SKU"
      }
    },
    "headnodeVMSize": {
      "type": "string",
      "metadata": {
        "description": "Specify head node VM size. Only use Extralarge for this preview."
      }
    },
    "adAvailabilitySetName": {
      "type": "string",
      "metadata": {
        "description": "The name of the availability set that the AD VM is created in"
      },
      "defaultValue": "adAvailabiltySet"
    },
    "domainName": {
      "type": "string",
      "metadata": {
        "description": "The FQDN of the AD Domain created "
      }
    },
    "dnsPrefix": {
      "type": "string",
      "metadata": {
        "description": "The DNS prefix for the public IP address used by the Load Balancer"
      }
    },
    "pdcRDPPort": {
      "type": "int",
      "metadata": {
        "description": "The public RDP port for the PDC VM"
      },
      "defaultValue": 3389
    },
    "bdcRDPPort": {
      "type": "int",
      "metadata": {
        "description": "The public RDP port for the BDC VM"
      },
      "defaultValue": 13389
    },
    "assetLocation": {
      "type": "string",
      "metadata": {
        "description": "The location of resources such as templates and DSC modules that the script is dependent"
      },
      "defaultValue": "http://nityawestus.blob.core.windows.net/adtemplateha"
    },
    "organizationalUnitDN": {
      "type": "string",
      "metadata": {
        "description": "Specify OU DN"
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the Administrator of the new VM and Domain"
      },
      "defaultValue": "adAdministrator"
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the Administrator account of the new VM and Domain"
      }
    },
    "newUserPrefix": {
      "type": "string",
      "metadata": {
        "description": "This template will create 4 AD users with the given prefix e.g. if the prefix is 'testuser', there will be 4 users created named testuser1, testuser2, testuser3, testuser4"
      }
    },
    "newUserPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the new users. All the 4 users will have the same password. It is highly recommended that you change it as soon as the cluster is created"
      }
    },
    "newGroupName": {
      "type": "string",
      "metadata": {
        "description": "Name of the AD group to be created. The 4 users will be added to this group"
      }
    },
    "secureLdapCertificate": {
      "type": "string",
      "metadata": {
        "description": "Base 64 encoded certificate to use for configuring secure ldap. The subject name must be *.<domain name>. The certificate must have the private key and should be marked exportable"
      }
    },
    "secureLdapCertificatePassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the secure ldap certificate"
      }
    }
  },
  "variables": {
    "cleanResourcePrefix": "[replace(replace(replace(toLower(parameters('clusterName')), '-', ''), '_', ''), '.', '')]",
    "clusterAttachedStorageName": "[parameters('clusterName')]",
    "serverName": "[concat('server', uniqueString(resourceGroup().id))]",
    "managedResourceGroupName": "[concat('databricks-rg-', parameters('clusterName'), '-', uniqueString(parameters('clusterName'), resourceGroup().id))]",
    "dataBaseName": "metastore",
    "dataBaseCollation": "SQL_Latin1_General_CP1_CI_AS",
    "dataBaseEdition": "Standard",
    "dataBaseRequestedServiceObjectiveName": "S2",
    "clusterVNetName": "[concat(parameters('clusterName'),'-vnet')]",
    "clusterVNetAddressSpace": "10.0.0.0/16",
    "clusterVNetSubnetName": "default",
    "clusterVNetSubnetAddressRange": "10.0.0.0/24",
    "adLBFE": "LBFE",
    "adLBBE": "LBBE",
    "adPDCRDPNAT": "adPDCRDP",
    "adBDCRDPNAT": "adBDCRDP",
    "VnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
    "adSubnetRef": "[concat(variables('VnetID'),'/subnets/',parameters('adSubnetName'))]",
    "adPDCNicId": "[resourceId('Microsoft.Network/networkInterfaces',parameters('adPDCNicName'))]",
    "adPDCIPConfigID": "[concat(variables('adPDCNicId'),'/ipConfigurations/ipconfig1')]",
    "adBDCNicId": "[resourceId('Microsoft.Network/networkInterfaces',parameters('adBDCNicName'))]",
    "adBDCIPConfigID": "[concat(variables('adBDCNicId'),'/ipConfigurations/ipconfig1')]",
    "adLBName": "adLoadBalancer",
    "adlbID": "[resourceId('Microsoft.Network/loadBalancers',variables('adLBName'))]",
    "adlbFEConfigID": "[concat(variables('adlbID'),'/frontendIPConfigurations/',variables('adLBFE'))]",
    "adPDCRDPNATRuleID": "[concat(variables('adlbID'),'/inboundNatRules/',variables('adPDCRDPNAT'))]",
    "adBDCRDPNATRuleID": "[concat(variables('adlbID'),'/inboundNatRules/',variables('adBDCRDPNAT'))]",
    "adBEAddressPoolID": "[concat(variables('adlbID'),'/backendAddressPools/',variables('adLBBE'))]",
    "adPDCDataDisk": "ADPDCDataDisk",
    "adBDCDataDisk": "ADBDCDataDisk",
    "adDataDiskSize": 1000,
    "vnetTemplateUri": "[concat(parameters('assetLocation'),'/nestedtemplates/vnet.json')]",
    "nicTemplateUri": "[concat(parameters('assetLocation'),'/nestedtemplates/nic.json')]",
    "vnetwithDNSTemplateUri": "[concat(parameters('assetLocation'),'/nestedtemplates/vnet-with-dns-server.json')]",
    "configureADBDCTemplateUri": "[concat(parameters('assetLocation'),'/nestedtemplates/configureADBDC.json')]",
    "adPDCModulesURL": "[concat(parameters('assetLocation'),'/DSC/CreateADPDC.ps1.zip')]",
    "adPDCConfigurationFunction": "CreateADPDC.ps1\\CreateADPDC",
    "adBDCPreparationModulesURL": "[concat(parameters('assetLocation'),'/DSC/PrepareADBDC.ps1.zip')]",
    "adBDCPreparationFunction": "PrepareADBDC.ps1\\PrepareADBDC",
    "adBDCConfigurationModulesURL": "[concat(parameters('assetLocation'),'/DSC/ConfigureADBDC.ps1.zip')]",
    "adBDCConfigurationFunction": "ConfigureADBDC.ps1\\ConfigureADBDC",
    "defaultApiVersion": "2015-05-01-preview",
    "clusterApiVersion": "2015-03-01-preview",
    "userGroupsArray": [
      "[parameters('newGroupName')]"
    ],
    "ldapsUrlsArray": [
      "[concat('ldaps://', parameters('domainName'),':636')]"
    ],
    "dataFactoryName": "[concat(variables('cleanResourcePrefix'), 'adf', uniqueString(resourceGroup().id))]",
    "factoryId": "[concat('Microsoft.DataFactory/factories/', variables('dataFactoryName'))]",
    "RetailData_BlobStorage_SasUri": "https://retaildatasamples.blob.core.windows.net/data?sv=2017-07-29&sr=c&sig=0%2FdYdx%2FW1X8EbO6GpH0R4ZEBrAUkYWqk2uz%2Fym5w3Gg%3D&st=2018-04-01T00%3A00%3A00Z&se=2099-12-31T12%3A59%3A59Z&sp=rl",
    "retailData_folderPath": "data/retaildata/rawdata/",
    "retailData_weblogs_folderPath": "[concat(variables('retailData_folderPath'), 'weblognew')]",
    "retailData_users_folderPath": "[concat(variables('retailData_folderPath'), 'UserFile')]",
    "retailData_products_folderPath": "[concat(variables('retailData_folderPath'), 'ProductFile')]",
    "weblogsDestinationPath": "data/weblogs/",
    "usersDestinationPath": "data/users/",
    "productsDestinationPath": "data/products/",
    "fileName": "part*.csv"
  },
  "resources": [
    {
      "name": "[variables('serverName')]",
      "type": "Microsoft.Sql/servers",
      "location": "[resourceGroup().location]",
      "apiVersion": "2014-04-01-preview",
      "dependsOn": [],
      "tags": {
        "displayName": "server"
      },
      "properties": {
        "administratorLogin": "[parameters('databaseAdminUsername')]",
        "administratorLoginPassword": "[parameters('databaseAdminPassword')]"
      },
      "resources": [
        {
          "name": "AllowAllWindowsAzureIps",
          "type": "firewallrules",
          "location": "[parameters('location')]",
          "apiVersion": "2014-04-01-preview",
          "dependsOn": [
            "[resourceId('Microsoft.Sql/servers', variables('serverName'))]"
          ],
          "properties": {
            "startIpAddress": "0.0.0.0",
            "endIpAddress": "0.0.0.0"
          }
        }
      ]
    },
    {
      "name": "[concat(variables('serverName'),'/',variables('dataBaseName'), copyIndex())]",
      "type": "Microsoft.Sql/servers/databases",
      "copy": {
        "name": "sqldatabasecopy",
        "count": "[parameters('clusterCount')]"
      },
      "location": "[resourceGroup().location]",
      "apiVersion": "2014-04-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('serverName'))]"
      ],
      "tags": {
        "displayName": "dataBase"
      },
      "properties": {
        "collation": "[variables('dataBaseCollation')]",
        "edition": "[variables('dataBaseEdition')]",
        "maxSizeBytes": "268435456000",
        "requestedServiceObjectiveName": "[variables('dataBaseRequestedServiceObjectiveName')]"
      }
    },
    {
      "name": "[variables('clusterAttachedStorageName')]",
      "type": "Microsoft.Storage/storageAccounts",
      "location": "[parameters('location')]",
      "apiVersion": "2016-01-01",
      "sku": {
        "name": "[parameters('clusterAttachedStorageType')]"
      },
      "dependsOn": [],
      "tags": {
        "displayName": "clusterattachedstorage"
      },
      "kind": "Storage"
    },
    {
      "name": "[concat(variables('clusterAttachedStorageName'),'llap')]",
      "type": "Microsoft.Storage/storageAccounts",
      "location": "[parameters('location')]",
      "apiVersion": "2016-01-01",
      "sku": {
        "name": "[parameters('clusterAttachedStorageType')]"
      },
      "dependsOn": [],
      "tags": {
        "displayName": "clusterattachedstorage"
      },
      "kind": "Storage"
    },
    {
      "name": "[concat(variables('clusterAttachedStorageName'),'dj')]",
      "type": "Microsoft.Storage/storageAccounts",
      "location": "[parameters('location')]",
      "apiVersion": "2016-01-01",
      "sku": {
        "name": "[parameters('clusterAttachedStorageType')]"
      },
      "dependsOn": [],
      "tags": {
        "displayName": "clusterattachedstorage"
      },
      "kind": "Storage"
    },
    {
      "name": "[concat(variables('clusterAttachedStorageName'),'kafka')]",
      "type": "Microsoft.Storage/storageAccounts",
      "location": "[parameters('location')]",
      "apiVersion": "2016-01-01",
      "sku": {
        "name": "[parameters('clusterAttachedStorageType')]"
      },
      "dependsOn": [],
      "tags": {
        "displayName": "clusterattachedstorage"
      },
      "kind": "Storage"
    },
    {
      "name": "[variables('clusterVNetName')]",
      "type": "Microsoft.Network/virtualNetworks",
      "location": "[resourceGroup().location]",
      "apiVersion": "[variables('defaultApiVersion')]",
      "dependsOn": [],
      "tags": {},
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('clusterVNetAddressSpace')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('clusterVNetSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('clusterVNetSubnetAddressRange')]"
            }
          }
        ]
      }
    },
    // Azure Data Factory
    {
      "name": "[variables('dataFactoryName')]",
      "type": "Microsoft.DataFactory/factories",
      "location": "[resourceGroup().location]",
      "apiVersion": "2017-09-01-preview",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {}
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/Pipeline_CopyRetailDataToStorageAccount')]",
      "type": "Microsoft.DataFactory/factories/pipelines",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "description": "Copies files from the retaildata public storage account to your storage account",
        "activities": [
          {
            "name": "Copy_weblogs",
            "type": "Copy",
            "dependsOn": [],
            "policy": {
              "timeout": "7.00:00:00",
              "retry": 0,
              "retryIntervalInSeconds": 30
            },
            "typeProperties": {
              "source": {
                "type": "BlobSource",
                "recursive": true
              },
              "sink": {
                "type": "BlobSink",
                "copyBehavior": "PreserveHierarchy"
              },
              "enableStaging": false,
              "cloudDataMovementUnits": 0,
              "enableSkipIncompatibleRow": true
            },
            "inputs": [
              {
                "referenceName": "retaildata_weblogs",
                "type": "DatasetReference",
                "parameters": {}
              }
            ],
            "outputs": [
              {
                "referenceName": "weblogs_output",
                "type": "DatasetReference",
                "parameters": {}
              }
            ]
          },
          {
            "name": "Copy_users",
            "type": "Copy",
            "dependsOn": [],
            "policy": {
              "timeout": "7.00:00:00",
              "retry": 0,
              "retryIntervalInSeconds": 30,
              "secureOutput": false
            },
            "typeProperties": {
              "source": {
                "type": "BlobSource",
                "recursive": true
              },
              "sink": {
                "type": "BlobSink",
                "copyBehavior": "PreserveHierarchy"
              },
              "enableStaging": false,
              "cloudDataMovementUnits": 0,
              "enableSkipIncompatibleRow": true
            },
            "inputs": [
              {
                "referenceName": "retaildata_users",
                "type": "DatasetReference",
                "parameters": {}
              }
            ],
            "outputs": [
              {
                "referenceName": "users_output",
                "type": "DatasetReference",
                "parameters": {}
              }
            ]
          },
          {
            "name": "Copy_products",
            "type": "Copy",
            "dependsOn": [],
            "policy": {
              "timeout": "7.00:00:00",
              "retry": 0,
              "retryIntervalInSeconds": 30,
              "secureOutput": false
            },
            "typeProperties": {
              "source": {
                "type": "BlobSource",
                "recursive": true
              },
              "sink": {
                "type": "BlobSink"
              },
              "enableStaging": false,
              "cloudDataMovementUnits": 0,
              "enableSkipIncompatibleRow": true
            },
            "inputs": [
              {
                "referenceName": "retaildata_products",
                "type": "DatasetReference",
                "parameters": {}
              }
            ],
            "outputs": [
              {
                "referenceName": "products_output",
                "type": "DatasetReference",
                "parameters": {}
              }
            ]
          }
        ]
      },
      "dependsOn": [
        "[concat(variables('factoryId'), '/datasets/retaildata_weblogs')]",
        "[concat(variables('factoryId'), '/datasets/weblogs_output')]",
        "[concat(variables('factoryId'), '/datasets/retaildata_users')]",
        "[concat(variables('factoryId'), '/datasets/users_output')]",
        "[concat(variables('factoryId'), '/datasets/retaildata_products')]",
        "[concat(variables('factoryId'), '/datasets/products_output')]"
      ]
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/retaildata_weblogs')]",
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "linkedServiceName": {
          "referenceName": "RetailData_BlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "AzureBlob",
        "structure": [
          {
            "name": "UserId",
            "type": "Int64"
          },
          {
            "name": "SessionId",
            "type": "String"
          },
          {
            "name": "ProductId",
            "type": "Int64"
          },
          {
            "name": "Quantity",
            "type": "Int64"
          },
          {
            "name": "Price",
            "type": "Double"
          },
          {
            "name": "TotalPrice",
            "type": "Double"
          },
          {
            "name": "ReferralURL",
            "type": "String"
          },
          {
            "name": "PageStopDuration",
            "type": "Int64"
          },
          {
            "name": "Action",
            "type": "String"
          },
          {
            "name": "TransactionDate",
            "type": "DateTime"
          }
        ],
        "typeProperties": {
          "format": {
            "type": "TextFormat",
            "columnDelimiter": "|",
            "treatEmptyAsNull": true,
            "firstRowAsHeader": true
          },
          "folderPath": "[variables('retaildata_weblogs_folderPath')]"
        }
      },
      "dependsOn": [
        "[concat(variables('factoryId'), '/linkedServices/RetailData_BlobStorage')]"
      ]
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/weblogs_output')]",
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "linkedServiceName": {
          "referenceName": "Destination_BlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "AzureBlob",
        "structure": [
          {
            "name": "UserId",
            "type": "Int64"
          },
          {
            "name": "SessionId",
            "type": "String"
          },
          {
            "name": "ProductId",
            "type": "Int64"
          },
          {
            "name": "Quantity",
            "type": "Int64"
          },
          {
            "name": "Price",
            "type": "Double"
          },
          {
            "name": "TotalPrice",
            "type": "Double"
          },
          {
            "name": "ReferralURL",
            "type": "String"
          },
          {
            "name": "PageStopDuration",
            "type": "Int64"
          },
          {
            "name": "Action",
            "type": "String"
          },
          {
            "name": "TransactionDate",
            "type": "DateTime"
          }
        ],
        "typeProperties": {
          "format": {
            "type": "TextFormat",
            "columnDelimiter": "|",
            "treatEmptyAsNull": true,
            "firstRowAsHeader": true
          },
          "folderPath": "[variables('weblogsDestinationPath')]"
        }
      },
      "dependsOn": [
        "[concat(variables('factoryId'), '/linkedServices/Destination_BlobStorage')]"
      ]
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/retaildata_users')]",
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "linkedServiceName": {
          "referenceName": "RetailData_BlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "AzureBlob",
        "typeProperties": {
          "format": {
            "type": "TextFormat",
            "columnDelimiter": ",",
            "rowDelimiter": "",
            "nullValue": "\\N",
            "treatEmptyAsNull": true,
            "firstRowAsHeader": false
          },
          "fileName": "[variables('fileName')]",
          "folderPath": "[variables('retaildata_users_folderPath')]"
        }
      },
      "dependsOn": [
        "[concat(variables('factoryId'), '/linkedServices/RetailData_BlobStorage')]"
      ]
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/users_output')]",
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "linkedServiceName": {
          "referenceName": "Destination_BlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "AzureBlob",
        "typeProperties": {
          "format": {
            "type": "TextFormat",
            "columnDelimiter": ",",
            "rowDelimiter": "",
            "nullValue": "\\N",
            "treatEmptyAsNull": true,
            "firstRowAsHeader": false
          },
          "folderPath": "[variables('usersDestinationPath')]"
        }
      },
      "dependsOn": [
        "[concat(variables('factoryId'), '/linkedServices/Destination_BlobStorage')]"
      ]
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/retaildata_products')]",
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "linkedServiceName": {
          "referenceName": "RetailData_BlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "AzureBlob",
        "typeProperties": {
          "format": {
            "type": "TextFormat",
            "columnDelimiter": ",",
            "rowDelimiter": "",
            "nullValue": "\\N",
            "treatEmptyAsNull": true,
            "firstRowAsHeader": false
          },
          "fileName": "[variables('fileName')]",
          "folderPath": "[variables('retaildata_products_folderPath')]"
        }
      },
      "dependsOn": [
        "[concat(variables('factoryId'), '/linkedServices/RetailData_BlobStorage')]"
      ]
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/products_output')]",
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "linkedServiceName": {
          "referenceName": "Destination_BlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "AzureBlob",
        "typeProperties": {
          "format": {
            "type": "TextFormat",
            "columnDelimiter": ",",
            "rowDelimiter": "",
            "nullValue": "\\N",
            "treatEmptyAsNull": true,
            "firstRowAsHeader": false
          },
          "folderPath": "[variables('productsDestinationPath')]"
        }
      },
      "dependsOn": [
        "[concat(variables('factoryId'), '/linkedServices/Destination_BlobStorage')]"
      ]
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/RetailData_BlobStorage')]",
      "type": "Microsoft.DataFactory/factories/linkedServices",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "type": "AzureStorage",
        "typeProperties": {
          "sasUri": {
            "type": "SecureString",
            "value": "[variables('RetailData_BlobStorage_SasUri')]"
          }
        }
      },
      "dependsOn": [
        "[variables('factoryId')]"
      ]
    },
    {
      "name": "[concat(variables('dataFactoryName'), '/Destination_BlobStorage')]",
      "type": "Microsoft.DataFactory/factories/linkedServices",
      "apiVersion": "2017-09-01-preview",
      "properties": {
        "type": "AzureStorage",
        "typeProperties": {
          "connectionString": {
            "type": "SecureString",
            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',variables('clusterAttachedStorageName'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('clusterAttachedStorageName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value)]"
          }
        }
      },
      "dependsOn": [
        "[concat('Microsoft.Storage/storageAccounts/',variables('clusterAttachedStorageName'))]",
        "[variables('factoryId')]"
      ]
    },
    // Azure Databricks workspace
    {
      "apiVersion": "2018-04-01",
      "name": "[concat(parameters('clusterName'), copyIndex())]",
      "condition": "[equals(parameters('provisionSpark'),'Yes')]",
      "copy": {
        "name": "databrickscopy",
        "count": "[parameters('clusterCount')]"
      },
      "type": "Microsoft.Databricks/workspaces",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('clusterAttachedStorageName'))]",
        "[resourceId('Microsoft.Sql/servers', variables('serverName'))]",
        "[resourceId('Microsoft.Sql/servers/databases', variables('serverName'), concat(variables('dataBaseName'),copyIndex()))]",
        "[concat('Microsoft.Network/virtualNetworks/',variables('clusterVNetName'))]"
      ],
      "sku": {
        "name": "[parameters('pricingTier')]"
      },
      "properties": {
        "ManagedResourceGroupId": "[concat(subscription().id, '/resourceGroups/', variables('managedResourceGroupName'))]"
      }
    },
    // LLAP Cluster
    {
      "apiVersion": "2015-03-01-preview",
      "name": "[concat(parameters('clusterName'), 'llap', copyIndex())]",
      "condition": "[equals(parameters('provisionLLAP'),'Yes')]",
      "copy": {
        "name": "hdinsightllapcopy",
        "count": "[parameters('clusterCount')]"
      },
      "type": "Microsoft.HDInsight/clusters",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', concat(variables('clusterAttachedStorageName'),'llap'))]",
        "[resourceId('Microsoft.Sql/servers', variables('serverName'))]",
        "[resourceId('Microsoft.Sql/servers/databases', variables('serverName'), concat(variables('dataBaseName'),copyIndex()))]"
      ],
      "properties": {
        "clusterVersion": "[parameters('clusterVersion')]",
        "osType": "Linux",
        "tier": "standard",
        "clusterDefinition": {
          "kind": "INTERACTIVEHIVE",
          "configurations": {
            "gateway": {
              "restAuthCredential.isEnabled": true,
              "restAuthCredential.username": "[parameters('clusterLoginUserName')]",
              "restAuthCredential.password": "[parameters('clusterLoginPassword')]"
            },
            "hive-site": {
              "javax.jdo.option.ConnectionDriverName": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
              "javax.jdo.option.ConnectionURL": "[concat('jdbc:sqlserver://',variables('serverName'),'.database.windows.net',';database=',variables('dataBaseName'),copyIndex(),';encrypt=true;trustServerCertificate=true;create=false;loginTimeout=300')]",
              "javax.jdo.option.ConnectionUserName": "[parameters('databaseAdminUsername')]",
              "javax.jdo.option.ConnectionPassword": "[parameters('databaseAdminPassword')]"
            },
            "hive-env": {
              "hive_database": "Existing MSSQL Server database with SQL authentication",
              "hive_database_name": "[concat(variables('dataBaseName'), copyIndex())]",
              "hive_database_type": "mssql",
              "hive_existing_mssql_server_database": "[concat(variables('dataBaseName'), copyIndex())]",
              "hive_existing_mssql_server_host": "[concat(variables('serverName'),'.database.windows.net')]",
              "hive_hostname": "[concat(variables('serverName'),'.database.windows.net')]"
            }
          }
        },
        "storageProfile": {
          "storageaccounts": [
            {
              "name": "[concat(variables('clusterAttachedStorageName'),'llap','.blob.core.windows.net')]",
              "isDefault": true,
              "container": "[concat(parameters('clusterName'), copyIndex())]",
              "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', concat(variables('clusterAttachedStorageName'),'llap')), variables('defaultApiVersion')).key1]"
            },
            {
              "name": "[concat(variables('clusterAttachedStorageName'),'.blob.core.windows.net')]",
              "isDefault": false,
              "container": "blank",
              "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('clusterAttachedStorageName')), variables('defaultApiVersion')).key1]"
            }
          ]
        },
        "computeProfile": {
          "roles": [
            {
              "name": "headnode",
              "minInstanceCount": 1,
              "targetInstanceCount": 2,
              "hardwareProfile": {
                "vmSize": "Standard_D13_V2"
              },
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]"
                }
              },
              "virtualNetworkProfile": null,
              "scriptActions": []
            },
            {
              "name": "workernode",
              "minInstanceCount": 1,
              "targetInstanceCount": 2,
              "hardwareProfile": {
                "vmSize": "Standard_D13_V2"
              },
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]"
                }
              },
              "virtualNetworkProfile": null,
              "scriptActions": []
            },
            {
              "name": "zookeepernode",
              "minInstanceCount": 1,
              "targetInstanceCount": 3,
              "hardwareProfile": {
                "vmSize": "Large"
              },
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]"
                }
              },
              "virtualNetworkProfile": null,
              "scriptActions": []
            }
          ]
        }
      }
    },
    // Kafka Cluster
    {
      "apiVersion": "[variables('clusterApiVersion')]",
      "location": "[parameters('location')]",
      "name": "[concat( 'kf', copyIndex(), parameters('clusterName'))]",
      "condition": "[equals(parameters('provisionKafka'),'Yes')]",
      "copy": {
        "name": "hdinsightkafkacopy",
        "count": "[parameters('clusterCount')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', concat(variables('clusterAttachedStorageName'),'kafka'))]",
        "[concat('Microsoft.Network/virtualNetworks/',variables('clusterVNetName'))]"
      ],
      "type": "Microsoft.HDInsight/clusters",
      "properties": {
        "clusterVersion": "[parameters('clusterVersion')]",
        "osType": "Linux",
        "tier": "standard",
        "clusterDefinition": {
          "kind": "kafka",
          "configurations": {
            "gateway": {
              "restAuthCredential.isEnabled": true,
              "restAuthCredential.username": "[parameters('clusterLoginUserName')]",
              "restAuthCredential.password": "[parameters('clusterLoginPassword')]"
            }
          }
        },
        "storageProfile": {
          "storageaccounts": [
            {
              "name": "[concat(variables('clusterAttachedStorageName'),'kafka','.blob.core.windows.net')]",
              "isDefault": true,
              "container": "[concat(parameters('clusterName'), copyIndex())]",
              "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', concat(variables('clusterAttachedStorageName'),'kafka')), variables('defaultApiVersion')).key1]"
            }
          ]
        },
        "computeProfile": {
          "roles": [
            {
              "name": "headnode",
              "minInstanceCount": 1,
              "targetInstanceCount": 2,
              "hardwareProfile": {
                "vmSize": "Standard_D12_V2"
              },
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]"
                }
              },
              "virtualNetworkProfile": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('clusterVNetName'))]",
                "subnet": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('clusterVNetName')), '/subnets/', variables('clusterVNetSubnetName'))]"
              }
            },
            {
              "name": "workernode",
              "minInstanceCount": 1,
              "targetInstanceCount": 3,
              "hardwareProfile": {
                "vmSize": "Standard_D12_V2"
              },
              "dataDisksGroups": [
                {
                  "disksPerNode": 2
                }
              ],
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]"
                }
              },
              "virtualNetworkProfile": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('clusterVNetName'))]",
                "subnet": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('clusterVNetName')), '/subnets/', variables('clusterVNetSubnetName'))]"
              }
            },
            {
              "name": "zookeepernode",
              "minInstanceCount": 1,
              "targetInstanceCount": 3,
              "hardwareProfile": {
                "vmSize": "Medium"
              },
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]"
                }
              },
              "virtualNetworkProfile": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('clusterVNetName'))]",
                "subnet": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('clusterVNetName')), '/subnets/', variables('clusterVNetSubnetName'))]"
              }
            }
          ]
        }
      }
    },
    // Secure Cluster and dependencies
    {
      "name": "[parameters('publicIPAddressName')]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2016-10-01",
      "location": "[parameters('location')]",
      "properties": {
        "publicIPAllocationMethod": "[parameters('publicIPAddressType')]",
        "dnsSettings": {
          "domainNameLabel": "[parameters('dnsPrefix')]"
        }
      }
    },
    {
      "name": "[parameters('adAvailabilitySetName')]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Compute/availabilitySets",
      "apiVersion": "2016-03-30",
      "location": "[parameters('location')]"
    },
    {
      "name": "VNet",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vnetTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[parameters('virtualNetworkName')]"
          },
          "virtualNetworkAddressRange": {
            "value": "[parameters('virtualNetworkAddressRange')]"
          },
          "subnetName": {
            "value": "[parameters('adSubnetName')]"
          },
          "subnetRange": {
            "value": "[parameters('adSubnet')]"
          }
        }
      }
    },
    {
      "name": "[variables('adLBName')]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Network/loadBalancers",
      "apiVersion": "2016-10-01",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses',parameters('publicIPAddressName'))]"
      ],
      "properties": {
        "frontendIPConfigurations": [
          {
            "name": "[variables('adLBFE')]",
            "properties": {
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',parameters('publicIPAddressName'))]"
              }
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "[variables('adLBBE')]"
          }
        ],
        "inboundNatRules": [
          {
            "name": "[variables('adPDCRDPNAT')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('adlbFEConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": "[parameters('pdcRDPPort')]",
              "backendPort": 3389,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[variables('adBDCRDPNAT')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('adlbFEConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": "[parameters('bdcRDPPort')]",
              "backendPort": 3389,
              "enableFloatingIP": false
            }
          }
        ]
      }
    },
    {
      "name": "[parameters('adPDCNicName')]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2016-10-01",
      "location": "[parameters('location')]",
      "dependsOn": [
        "Microsoft.Resources/deployments/VNet",
        "[concat('Microsoft.Network/loadBalancers/',variables('adLBName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIPAddress": "[parameters('adPDCNicIPAddress')]",
              "subnet": {
                "id": "[variables('adSubnetRef')]"
              },
              "loadBalancerBackendAddressPools": [
                {
                  "id": "[variables('adBEAddressPoolID')]"
                }
              ],
              "loadBalancerInboundNatRules": [
                {
                  "id": "[variables('adPDCRDPNATRuleID')]"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "name": "[parameters('adBDCNicName')]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2016-10-01",
      "location": "[parameters('location')]",
      "dependsOn": [
        "Microsoft.Resources/deployments/VNet",
        "[concat('Microsoft.Network/loadBalancers/',variables('adLBName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIPAddress": "[parameters('adBDCNicIPAddress')]",
              "subnet": {
                "id": "[variables('adSubnetRef')]"
              },
              "loadBalancerBackendAddressPools": [
                {
                  "id": "[variables('adBEAddressPoolID')]"
                }
              ],
              "loadBalancerInboundNatRules": [
                {
                  "id": "[variables('adBDCRDPNATRuleID')]"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "name": "[parameters('adPDCVMName')]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2016-03-30",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts',variables('clusterAttachedStorageName'))]",
        "[resourceId('Microsoft.Network/networkInterfaces',parameters('adPDCNicName'))]",
        "[resourceId('Microsoft.Compute/availabilitySets', parameters('adAvailabilitySetName'))]",
        "[resourceId('Microsoft.Network/loadBalancers',variables('adLBName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('adVMSize')]"
        },
        "availabilitySet": {
          "id": "[resourceId('Microsoft.Compute/availabilitySets', parameters('adAvailabilitySetName'))]"
        },
        "osProfile": {
          "computerName": "[parameters('adPDCVMName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[parameters('imagePublisher')]",
            "offer": "[parameters('imageOffer')]",
            "sku": "[parameters('imageSKU')]",
            "version": "latest"
          },
          "osDisk": {
            "name": "osdisk",
            "vhd": {
              "uri": "[concat(reference(resourceId('Microsoft.Storage/storageAccounts/', variables('clusterAttachedStorageName'))).primaryEndpoints.blob,'vhds0/','osdisk.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          },
          "dataDisks": [
            {
              "vhd": {
                "uri": "[concat(reference(resourceId('Microsoft.Storage/storageAccounts/', variables('clusterAttachedStorageName'))).primaryEndpoints.blob,'vhds0/', variables('adPDCDataDisk'),'-1.vhd')]"
              },
              "name": "[concat(parameters('adPDCVMName'),'-data-disk1')]",
              "caching": "None",
              "diskSizeGB": "[variables('adDataDiskSize')]",
              "lun": 0,
              "createOption": "empty"
            }
          ]
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',parameters('adPDCNicName'))]"
            }
          ]
        }
      },
      "resources": [
        {
          "name": "[concat(parameters('adPDCVMName'),'/CreateADForest')]",
          "condition": "[equals(parameters('provisionSecure'),'Yes')]",
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "apiVersion": "2016-03-30",
          "location": "[parameters('location')]",
          "dependsOn": [
            "[resourceId('Microsoft.Compute/virtualMachines', parameters('adPDCVMName'))]"
          ],
          "properties": {
            "publisher": "Microsoft.Powershell",
            "type": "DSC",
            "typeHandlerVersion": "2.21",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "ModulesUrl": "[variables('adPDCModulesURL')]",
              "ConfigurationFunction": "[variables('adPDCConfigurationFunction')]",
              "Properties": {
                "DomainName": "[parameters('domainName')]",
                "LdapsCertificateContent": "[parameters('secureLdapCertificate')]",
                "LdapsCertificatePassword": "[parameters('secureLdapCertificatePassword')]",
                "NewGroupName": "[parameters('newGroupName')]",
                "AdminCreds": {
                  "UserName": "[parameters('adminUsername')]",
                  "Password": "PrivateSettingsRef:AdminPassword"
                },
                "NewUsercreds": {
                  "UserName": "[parameters('newUserPrefix')]",
                  "Password": "PrivateSettingsRef:NewUserPassword"
                },
                "DnsServerZone": "[parameters('dnsServerZone')]",
              }
            },
            "protectedSettings": {
              "Items": {
                "AdminPassword": "[parameters('adminPassword')]",
                "NewUserPassword": "[parameters('newUserPassword')]"
              }
            }
          }
        }
      ]
    },
    {
      "name": "UpdateVNetDNS1",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', parameters('adPDCVMName'),'/extensions/CreateADForest')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vnetwithDNSTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[parameters('virtualNetworkName')]"
          },
          "virtualNetworkAddressRange": {
            "value": "[parameters('virtualNetworkAddressRange')]"
          },
          "subnetName": {
            "value": "[parameters('adSubnetName')]"
          },
          "subnetRange": {
            "value": "[parameters('adSubnet')]"
          },
          "DNSServerAddress": {
            "value": [
              "[parameters('adPDCNicIPAddress')]"
            ]
          }
        }
      }
    },
    {
      "name": "UpdateBDCNIC",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/',parameters('adBDCNicName'))]",
        "Microsoft.Resources/deployments/UpdateVNetDNS1"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('nicTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nicName": {
            "value": "[parameters('adBDCNicName')]"
          },
          "ipConfigurations": {
            "value": [
              {
                "name": "ipconfig1",
                "properties": {
                  "privateIPAllocationMethod": "Static",
                  "privateIPAddress": "[parameters('adBDCNicIPAddress')]",
                  "subnet": {
                    "id": "[variables('adSubnetRef')]"
                  },
                  "loadBalancerBackendAddressPools": [
                    {
                      "id": "[variables('adBEAddressPoolID')]"
                    }
                  ],
                  "loadBalancerInboundNatRules": [
                    {
                      "id": "[variables('adBDCRDPNATRuleID')]"
                    }
                  ]
                }
              }
            ]
          },
          "dnsServers": {
            "value": [
              "[parameters('adPDCNicIPAddress')]"
            ]
          }
        }
      }
    },
    {
      "name": "[parameters('adBDCVMName')]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2016-03-30",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts',variables('clusterAttachedStorageName'))]",
        "[resourceId('Microsoft.Network/networkInterfaces',parameters('adBDCNicName'))]",
        "[resourceId('Microsoft.Compute/availabilitySets', parameters('adAvailabilitySetName'))]",
        "[resourceId('Microsoft.Network/loadBalancers',variables('adLBName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('adVMSize')]"
        },
        "availabilitySet": {
          "id": "[resourceId('Microsoft.Compute/availabilitySets', parameters('adAvailabilitySetName'))]"
        },
        "osProfile": {
          "computerName": "[parameters('adBDCVMName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[parameters('imagePublisher')]",
            "offer": "[parameters('imageOffer')]",
            "sku": "[parameters('imageSKU')]",
            "version": "latest"
          },
          "osDisk": {
            "name": "osdisk",
            "vhd": {
              "uri": "[concat(reference(resourceId('Microsoft.Storage/storageAccounts/', variables('clusterAttachedStorageName'))).primaryEndpoints.blob,'vhds1/','osdisk.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          },
          "dataDisks": [
            {
              "vhd": {
                "uri": "[concat(reference(resourceId('Microsoft.Storage/storageAccounts/', variables('clusterAttachedStorageName'))).primaryEndpoints.blob,'vhds1/',variables('adBDCDataDisk'),'-1.vhd')]"
              },
              "name": "[concat(parameters('adBDCVMName'),'-data-disk1')]",
              "caching": "None",
              "diskSizeGB": "[variables('adDataDiskSize')]",
              "lun": 0,
              "createOption": "empty"
            }
          ]
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',parameters('adBDCNicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('adBDCVMName'),'/PrepareBDC')]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "apiVersion": "2016-03-30",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', parameters('adBDCVMName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.21",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('adBDCPreparationModulesURL')]",
          "ConfigurationFunction": "[variables('adBDCPreparationFunction')]",
          "Properties": {
            "DNSServer": "[parameters('adPDCNicIPAddress')]"
          }
        }
      }
    },
    {
      "name": "ConfiguringBackupADDomainController",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('adBDCVMName'),'/extensions/PrepareBDC')]",
        "Microsoft.Resources/deployments/UpdateBDCNIC"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('configureADBDCTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adBDCVMName": {
            "value": "[parameters('adBDCVMName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "secureLdapCertificate": {
            "value": "[parameters('secureLdapCertificate')]"
          },
          "secureLdapCertificatePassword": {
            "value": "[parameters('secureLdapCertificatePassword')]"
          },
          "adBDCConfigurationFunction": {
            "value": "[variables('adBDCConfigurationFunction')]"
          },
          "adBDCConfigurationModulesURL": {
            "value": "[variables('adBDCConfigurationModulesURL')]"
          }
        }
      }
    },
    {
      "name": "UpdateVNetDNS2",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/ConfiguringBackupADDomainController"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vnetwithDNSTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[parameters('virtualNetworkName')]"
          },
          "virtualNetworkAddressRange": {
            "value": "[parameters('virtualNetworkAddressRange')]"
          },
          "subnetName": {
            "value": "[parameters('adSubnetName')]"
          },
          "subnetRange": {
            "value": "[parameters('adSubnet')]"
          },
          "DNSServerAddress": {
            "value": [
              "[parameters('adPDCNicIPAddress')]",
              "[parameters('adBDCNicIPAddress')]"
            ]
          }
        }
      }
    },
    {
      "apiVersion": "[variables('clusterApiVersion')]",
      "location": "[parameters('location')]",
      "name": "[concat( 'dj', copyIndex(), parameters('clusterName'))]",
      "condition": "[equals(parameters('provisionSecure'),'Yes')]",
      "copy": {
        "name": "hdinsightsecurecopy",
        "count": "[parameters('clusterCount')]"
      },
      "type": "Microsoft.HDInsight/clusters",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'UpdateVNetDNS2')]",
        "[resourceId('Microsoft.Storage/storageAccounts', concat(variables('clusterAttachedStorageName'),'dj'))]",
        "[resourceId('Microsoft.Sql/servers', variables('serverName'))]",
        "[resourceId('Microsoft.Sql/servers/databases', variables('serverName'), concat(variables('dataBaseName'),copyIndex()))]"
      ],
      "properties": {
        "clusterVersion": "[parameters('clusterVersion')]",
        "osType": "Linux",
        "tier": "premium",
        "clusterDefinition": {
          "kind": "spark",
          "configurations": {
            "gateway": {
              "restAuthCredential.isEnabled": "true",
              "restAuthCredential.username": "[parameters('clusterLoginUserName')]",
              "restAuthCredential.password": "[parameters('clusterLoginPassword')]"
            },
            "hive-site": {
              "javax.jdo.option.ConnectionDriverName": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
              "javax.jdo.option.ConnectionURL": "[concat('jdbc:sqlserver://',variables('serverName'),'.database.windows.net',';database=',variables('dataBaseName'),copyIndex(),';encrypt=true;trustServerCertificate=true;create=false;loginTimeout=300')]",
              "javax.jdo.option.ConnectionUserName": "[parameters('databaseAdminUsername')]",
              "javax.jdo.option.ConnectionPassword": "[parameters('databaseAdminPassword')]"
            },
            "hive-env": {
              "hive_database": "Existing MSSQL Server database with SQL authentication",
              "hive_database_name": "[concat(variables('dataBaseName'), copyIndex())]",
              "hive_database_type": "mssql",
              "hive_existing_mssql_server_database": "[concat(variables('dataBaseName'), copyIndex())]",
              "hive_existing_mssql_server_host": "[concat(variables('serverName'),'.database.windows.net')]",
              "hive_hostname": "[concat(variables('serverName'),'.database.windows.net')]"
            }
          }
        },
        "storageProfile": {
          "storageaccounts": [
            {
              "name": "[concat(variables('clusterAttachedStorageName'),'dj','.blob.core.windows.net')]",
              "isDefault": true,
              "container": "[concat(parameters('clusterName'), copyIndex())]",
              "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', concat(variables('clusterAttachedStorageName'),'dj')), variables('defaultApiVersion')).key1]"
            },
            {
              "name": "[concat(variables('clusterAttachedStorageName'),'.blob.core.windows.net')]",
              "isDefault": false,
              "container": "blank",
              "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('clusterAttachedStorageName')), variables('defaultApiVersion')).key1]"
            }
          ]
        },
        "securityProfile": {
          "directoryType": "ActiveDirectory",
          "domain": "[parameters('domainName')]",
          "organizationalUnitDN": "[parameters('organizationalUnitDN')]",
          "ldapsUrls": "[variables('ldapsUrlsArray')]",
          "domainUsername": "[concat(parameters('adminUsername'), '@', parameters('domainName'))]",
          "domainUserPassword": "[parameters('adminPassword')]",
          "clusterUsersGroupDNs": "[variables('userGroupsArray')]"
        },
        "computeProfile": {
          "roles": [
            {
              "name": "headnode",
              "targetInstanceCount": 2,
              "hardwareProfile": {
                "vmSize": "[parameters('headnodeVMSize')]"
              },
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]",
                  "sshProfile": {
                    "publicKeys": [
                      {
                        "certificateData": "[parameters('sshPublicKey')]"
                      }
                    ]
                  }
                }
              },
              "virtualNetworkProfile": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
                "subnet": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('adSubnetName'))]"
              },
              "scriptActions": []
            },
            {
              "name": "workernode",
              "targetInstanceCount": "[parameters('clusterWorkerNodeCount')]",
              "hardwareProfile": {
                "vmSize": "ExtraLarge"
              },
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]",
                  "sshProfile": {
                    "publicKeys": [
                      {
                        "certificateData": "[parameters('sshPublicKey')]"
                      }
                    ]
                  }
                }
              },
              "virtualNetworkProfile": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
                "subnet": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('adSubnetName'))]"
              },
              "scriptActions": []
            },
            {
              "name": "zookeepernode",
              "targetInstanceCount": 3,
              "hardwareProfile": {
                "vmSize": "Small"
              },
              "osProfile": {
                "linuxOperatingSystemProfile": {
                  "username": "[parameters('sshUserName')]",
                  "password": "[parameters('sshPassword')]",
                  "sshProfile": {
                    "publicKeys": [
                      {
                        "certificateData": "[parameters('sshPublicKey')]"
                      }
                    ]
                  }
                }
              },
              "virtualNetworkProfile": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
                "subnet": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('adSubnetName'))]"
              },
              "scriptActions": []
            }
          ]
        }
      },
      "tags": {},
      "type": "Microsoft.HDInsight/clusters"
    }
  ],
  "outputs": {}
}